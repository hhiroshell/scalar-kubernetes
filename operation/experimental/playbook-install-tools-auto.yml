---
- name: Read Terraform modules and set Ansible vars
  hosts: localhost
  connection: local
  gather_facts: no
  become: no
  vars:
    DEBUG: no
  tasks:
  - name: Load network tfstate file
    include_vars:
      file: ../../examples/azure/network/terraform.tfstate
      name: tf_network_json

  - name: Retrieve bastion_ip and user_name from network tfstate
    set_fact:
      bastion_ip: "{{ tf_network_json.outputs.bastion_ip.value }}"
      user_name: "{{ tf_network_json.outputs.user_name.value }}"

  - name: View value bastion_ip
    debug:
      var: bastion_ip
    when: DEBUG

  - name: View value user_name
    debug:
      var: user_name
    when: DEBUG

  - name: Add bastion ip to Ansible inventory
    add_host:
      hostname: bastion
      ansible_ssh_host: "{{ bastion_ip }}"
      ansible_user: "{{ user_name }}"
      groups: bastion

  - name: Load kubernetes tfstate file
    include_vars:
      file: ../../examples/azure/kubernetes/terraform.tfstate
      name: tf_kubernetes_json

  - name: Retrieve kube_config from network tfstate
    set_fact:
      kube_config: "{{ tf_kubernetes_json.outputs.kube_config.value }}"

  - name: View value kube_config
    debug:
      var: kube_config
    when: DEBUG

  - name: Copy the kube_config into tmp
    copy:
      content: "{{ kube_config }}"
      dest: ../tmp/kube_config

- name: Install necessary kubernetes binary on bastion
  hosts: bastion
  gather_facts: no
  become: yes
  vars:
    KUBE_CONFIG: ../tmp/kube_config
  pre_tasks:
  # ansible require to use python3 as the python2 is end of support
  # need to view with team
  - name: Switch Ansible's Python interpreter to Python 2
    set_fact:
      ansible_python_interpreter: "/usr/bin/python"
  - name: Ensure libselinux-python3 is installed (to use copy in ansible)
    package:
      name: libselinux-python3
      state: present
  - name: Switch Ansible's Python interpreter to Python 3
    set_fact:
      ansible_python_interpreter: "/usr/bin/python3"
  roles:
    - "scalar.kubectl"
    - "scalar.helm"
  tags:
  - kubernetes tool

- name: Cleanup
  hosts: localhost
  connection: local
  gather_facts: no
  become: no
  tasks:
  - name: Cleanup file (kube_config) in tmp directory
    file:
      path: ../tmp/kube_config
      state: absent

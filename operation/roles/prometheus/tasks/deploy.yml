---
- name: Create namespace for Prometheus
  k8s:
    name: "{{ namespace }}"
    api_version: v1
    kind: Namespace
    state: present

- name: Download Custom Ressource Definition
  get_url:
    url: "{{ item }}"
    dest: "{{ remote_directory }}/helm/crds/"
  loop: "{{ prometheus_crds_url }}"
  register: prometheus_crds_path

- name: Deploy Prometheus CRDs
  k8s:
    state: present
    src: "{{ item.dest }}"
  with_items: "{{ prometheus_crds_path.results | list }}"

- name: wait Prometheus CRDS install in Kubernetes cluster
  pause:
    seconds: "30"

- name: Deploy/Upgrade prometheus with helm
  command: >-
    {{ helm_binary_path }} upgrade --install prometheus stable/prometheus-operator
    --namespace {{ namespace }} --version {{ prometheus_version }} -f {{ remote_directory }}/helm/prometheus-custom-values.yaml
  when: deploy_prometheus and not alertmanager_notification_activated

- name: Deploy/Upgrade prometheus with helm with alertmanager slack set
  command: >-
    {{ helm_binary_path }} upgrade --install prometheus stable/prometheus-operator
    --namespace {{ namespace }} --version {{ prometheus_version }} -f {{ remote_directory }}/helm/prometheus-custom-values.yaml
    -f {{ remote_directory }}/helm/prometheus-custom-values-alertmanager.yaml
    --set alertmanager.config.global.slack_api_url={{ slack_webhook_url }}
  when: deploy_prometheus and alertmanager_notification_activated and slack_webhook_url is defined

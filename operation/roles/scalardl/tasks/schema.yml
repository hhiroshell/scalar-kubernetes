---
- name: Get files on remote machine for Scalar-schema
  find:
    paths: "{{ remote_manifests_folder }}/schema/"
    patterns: '*.yaml'
  register: find_yaml_schema

- name: Deploy Scalar-schema
  k8s:
    state: present
    src: "{{ item.path }}"
    namespace: "{{ default_kubernetes_namespace }}"
  with_items: "{{ find_yaml_schema.files }}"
  loop_control:
    label: "{{ item.path }}"

- name: Wait until completion
  k8s_info:
    api_version: batch/v1
    kind: Job
    label_selectors:
      - "app.kubernetes.io/name = {{ job_scalardl_schema_version }}"
      - "app.kubernetes.io/version = {{ job_scalardl_schema_version }}"
    namespace: "{{ default_kubernetes_namespace }}"
  register: deployment_list
  until: deployment_list | json_query('resources[*].status.conditions[?type==`Complete`].status[]') | unique == ["True"]
  retries: 10
  delay: 5

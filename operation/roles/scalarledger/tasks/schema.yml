---
- name: Get files on remote machine for scalar schema
  find:
    paths: "{{ remote_manifests_folder }}/schema/"
    patterns: '*.yaml'
  register: find_yaml_schema

- name: Deploy scalar schema
  k8s:
    state: present
    src: "{{ item.path }}"
    namespace: "{{ default_kubernetes_namespace }}"
  with_items: "{{ find_yaml_schema.files }}"
  loop_control:
    label: "{{ item.path }}"

- name: Wait until completion
  k8s_info:
    api_version: batch/v1
    kind: Job
    label_selectors:
      - app.kubernetes.io/name = scalardl-schema
      - app.kubernetes.io/version = v2.0.5
    namespace: "{{ default_kubernetes_namespace }}"
  register: deployment_list
  until: deployment_list | json_query('status.succeeded') == 1
  retries: 50
  delay: 5
  # pause:
  #   minutes: 1
